{% extends 'base.html' %}

{% block title %}Viagens · tamo junto{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/viagens.css') }}">
{% endblock %}

{% block content %}
<div class="wrap">

  <header class="page-header">
    <span class="eyebrow">lugares para explorar juntos</span>
    <h1 class="page-title">Nossa lista de<br><em>Viagens</em></h1>
    <p class="page-sub">cada destino só vai valer a pena pq é com voce</p>
  </header>

  <div class="stats-bar" aria-label="Estatísticas de viagens">
    <div class="stat">
      <div class="stat-num" id="s-total">0</div>
      <div class="stat-label">Destinos</div>
    </div>
  </div>

  <section class="form-section" aria-label="Adicionar viagem">
    <p class="form-heading">✦ Adicionar Destino</p>

    <form id="standalone-trip-form" class="form-grid">
      <div class="form-group">
        <label for="fDest">Destino</label>
        <input type="text" id="fDest" name="fDest" placeholder="ex: Gramado, Portugal..." autocomplete="off" required>
      </div>
      <div class="form-group">
        <label for="targetDate">Quando (Data Oficial)?</label>
        <input type="date" id="targetDate" name="targetDate" required>
      </div>
      <div class="form-group">
        <label for="fStatus">Status</label>
        <select id="fStatus" name="fStatus">
          <option value="sonho">✦ Sonho</option>
          <option value="planejada">◈ Planejada</option>
          <option value="feita">✓ Feita</option>
        </select>
      </div>
      <div class="form-group">
        <label for="fQuem">Quem quer ir?</label>
        <input type="text" id="fQuem" name="fQuem" placeholder="hesron, mozi, os dois...">
      </div>
      <div class="form-group span2">
        <label for="fNotes">O que queremos fazer lá?</label>
        <textarea id="fNotes" name="fNotes" rows="3" placeholder="Restaurantes, pontos turísticos, experiências..."></textarea>
      </div>
      <div class="form-group span2">
        <button id="btn-add-trip" class="btn-submit" type="submit">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          <span>Adicionar Viagem</span>
        </button>
      </div>
    </form>
  </section>

  <div class="trip-list" id="tripList" aria-label="Lista de viagens" aria-live="polite">
    <div class="empty-state">
      <p>✦</p>
      <p>Carregando rotas...</p>
    </div>
  </div>

</div>

<dialog id="edit-dialog-trip" aria-labelledby="edit-trip-title">
  <div class="dialog-header">
    <h3 id="edit-trip-title" style="margin: 0;">Editar Viagem</h3>
    <button type="button" class="btn-close-dialog" onclick="document.getElementById('edit-dialog-trip').close()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>
  <form id="edit-trip-form" class="form-grid" novalidate>
    <input type="hidden" id="edit-tKey">
    <div class="form-group">
      <label for="edit-tDest">Destino</label>
      <input type="text" id="edit-tDest" required>
    </div>
    <div class="form-group">
      <label for="edit-tTargetDate">Quando?</label>
      <input type="date" id="edit-tTargetDate" required>
    </div>
    <div class="form-group">
      <label for="edit-tStatus">Status</label>
      <select id="edit-tStatus">
        <option value="sonho">✦ Sonho</option>
        <option value="planejada">◈ Planejada</option>
        <option value="feita">✓ Feita</option>
      </select>
    </div>
    <div class="form-group">
      <label for="edit-tQuem">Quem quer ir?</label>
      <input type="text" id="edit-tQuem">
    </div>
    <div class="form-group span2">
      <label for="edit-tNotes">O que queremos fazer lá?</label>
      <textarea id="edit-tNotes" rows="3"></textarea>
    </div>
    <div class="form-group span2">
      <button class="btn-submit" type="submit">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        <span>Salvar Alterações</span>
      </button>
    </div>
  </form>
</dialog>

<script type="module">
  import { ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
  import { db } from "/static/js/app.js";

  const viagensRef = ref(db, 'viagens');

  let trips = [];
  const editDialog = document.getElementById('edit-dialog-trip');

  onValue(viagensRef, (snapshot) => {
    trips = [];
    snapshot.forEach((childSnapshot) => {
      trips.push({ key: childSnapshot.key, ...childSnapshot.val() });
    });
    trips.reverse();
    renderTrips();
  });

  function renderTrips() {
    const list = document.getElementById('tripList');
    list.innerHTML = '';
    document.getElementById('s-total').textContent = trips.length;

    if (!trips.length) {
      list.innerHTML = `
        <div class="empty-state">
          <p>Nenhuma viagem na lista ainda. Comecem a sonhar!</p>
        </div>`;
      return;
    }

    trips.forEach(t => {
      const card = document.createElement('div');
      card.className = 'trip-card';
      
      const dateStr = t.targetDate ? t.targetDate.split('-').reverse().join('/') : '';
      const dateHtml = dateStr ? `<time datetime="${t.targetDate}" style="margin-right: 8px; color: var(--gold-pale); display:inline-flex; align-items:center; gap:4px;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> 
        ${dateStr}</time>` : '';

      card.innerHTML = `
        <div class="trip-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
        </div>
        <div class="trip-body">
          <div class="trip-dest">${t.dest}</div>
          <div class="trip-meta">
            ${dateHtml} ${t.quem ? `• ${t.quem}` : ''}
          </div>
          ${t.notes ? `<div class="trip-notes">${t.notes}</div>` : ''}
          <span class="status-badge badge-${t.status}">${t.status.toUpperCase()}</span>
        </div>
        <div class="trip-actions">
          <button class="btn-icon edit" onclick="window.openEditTrip('${t.key}')" aria-label="Editar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          </button>
          <button class="btn-icon del" onclick="window.deleteTrip('${t.key}')" aria-label="Excluir">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
      `;
      list.appendChild(card);
    });
  }

  document.getElementById('standalone-trip-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const dest = document.getElementById('fDest').value.trim();
    if (!dest) return;

    await push(viagensRef, {
      dest,
      targetDate: document.getElementById('targetDate').value,
      status: document.getElementById('fStatus').value,
      quem: document.getElementById('fQuem').value.trim(),
      notes: document.getElementById('fNotes').value.trim()
    });

    document.getElementById('standalone-trip-form').reset();
  });

  window.deleteTrip = function(key) {
    remove(ref(db, 'viagens/' + key));
  };

  window.openEditTrip = function(key) {
    const t = trips.find(trip => trip.key === key);
    if (!t) return;

    document.getElementById('edit-tKey').value = t.key;
    document.getElementById('edit-tDest').value = t.dest || '';
    document.getElementById('edit-tTargetDate').value = t.targetDate || '';
    document.getElementById('edit-tStatus').value = t.status || 'sonho';
    document.getElementById('edit-tQuem').value = t.quem || '';
    document.getElementById('edit-tNotes').value = t.notes || '';

    editDialog.showModal();
  };

  document.getElementById('edit-trip-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const key = document.getElementById('edit-tKey').value;
    
    await update(ref(db, 'viagens/' + key), {
      dest: document.getElementById('edit-tDest').value.trim(),
      targetDate: document.getElementById('edit-tTargetDate').value,
      status: document.getElementById('edit-tStatus').value,
      quem: document.getElementById('edit-tQuem').value.trim(),
      notes: document.getElementById('edit-tNotes').value.trim()
    });

    editDialog.close();
  });
</script>
{% endblock %}