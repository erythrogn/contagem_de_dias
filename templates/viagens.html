{% extends 'base.html' %}

{% block title %}Viagens Â· tamo junto{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/viagens.css') }}">
{% endblock %}

{% block content %}
<div class="wrap">

  <header class="page-header">
    <span class="eyebrow">lugares para explorar juntos</span>
    <h1 class="page-title">Nossa lista de<br><em>Viagens</em></h1>
    <p class="page-sub">cada destino sÃ³ vai valer a pena pq Ã© com voce</p>
  </header>

  <div class="stats-bar" aria-label="EstatÃ­sticas de viagens">
    <div class="stat">
      <div class="stat-num" id="s-total">0</div>
      <div class="stat-label">Destinos</div>
    </div>
  </div>

  <section class="form-section" aria-label="Adicionar viagem">
    <p class="form-heading">âœ¦ Adicionar Destino</p>

    <form id="standalone-trip-form" class="form-grid">

      <div class="form-group">
        <label for="fDest">Destino</label>
        <input
          type="text"
          id="fDest"
          name="fDest"
          placeholder="ex: Gramado, Portugal..."
          autocomplete="off"
          required
        >
      </div>

      <div class="form-group">
        <label for="targetDate">Quando (Data Oficial)?</label>
        <input
          type="date"
          id="targetDate"
          name="targetDate"
          required
        >
      </div>

      <div class="form-group">
        <label for="fStatus">Status</label>
        <select id="fStatus" name="fStatus">
          <option value="sonho">âœ¦ Sonho</option>
          <option value="planejada">â—ˆ Planejada</option>
          <option value="feita">âœ“ Feita</option>
        </select>
      </div>

      <div class="form-group">
        <label for="fQuem">Quem quer ir?</label>
        <input
          type="text"
          id="fQuem"
          name="fQuem"
          placeholder="hesron, mozi, os dois..."
        >
      </div>

      <div class="form-group span2">
        <label for="fNotes">O que queremos fazer lÃ¡?</label>
        <textarea
          id="fNotes"
          name="fNotes"
          rows="3"
          placeholder="Restaurantes, pontos turÃ­sticos, experiÃªncias..."></textarea>
      </div>

      <div class="form-group span2">
        <button id="btn-add-trip" class="btn-submit" type="submit">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          <span>Adicionar Viagem</span>
        </button>
      </div>

    </form>
  </section>

  <div class="trip-list" id="tripList" aria-label="Lista de viagens" aria-live="polite">
    <div class="empty-state">
      <p>âœ¦</p>
      <p>Carregando rotas...</p>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

  const firebaseConfig = {
    databaseURL: "https://contagem-de-dias-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const viagensRef = ref(db, 'viagens');

  let trips = [];

  onValue(viagensRef, (snapshot) => {
    trips = [];
    snapshot.forEach((childSnapshot) => {
      trips.push({ key: childSnapshot.key, ...childSnapshot.val() });
    });
    trips.reverse();
    renderTrips();
  });

  function renderTrips() {
    const list = document.getElementById('tripList');
    list.innerHTML = '';
    document.getElementById('s-total').textContent = trips.length;

    if (!trips.length) {
      list.innerHTML = `
        <div class="empty-state">
          <p>Nenhuma viagem na lista ainda. Comecem a sonhar!</p>
        </div>`;
      return;
    }

    trips.forEach(t => {
      const card = document.createElement('div');
      card.className = 'trip-card';
      
      const iconSvg = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
      
      const dateStr = t.targetDate ? t.targetDate.split('-').reverse().join('/') : '';
      const dateHtml = dateStr ? `<span style="margin-right: 8px; color: var(--gold-pale);">ðŸ“… ${dateStr}</span>` : '';

      card.innerHTML = `
        <div class="trip-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
        </div>
        <div class="trip-body">
          <div class="trip-dest">${t.dest}</div>
          <div class="trip-meta">
            ${dateHtml} ${t.quem ? `â€¢ ${t.quem}` : ''}
          </div>
          ${t.notes ? `<div class="trip-notes">${t.notes}</div>` : ''}
          <span class="status-badge badge-${t.status}">${t.status.toUpperCase()}</span>
        </div>
        <div class="trip-actions">
          <button class="btn-icon" onclick="window.deleteTrip('${t.key}')">${iconSvg}</button>
        </div>
      `;
      list.appendChild(card);
    });
  }

  document.getElementById('standalone-trip-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const dest = document.getElementById('fDest').value.trim();
    if (!dest) return;

    await push(viagensRef, {
      dest,
      targetDate: document.getElementById('targetDate').value,
      status: document.getElementById('fStatus').value,
      quem: document.getElementById('fQuem').value.trim(),
      notes: document.getElementById('fNotes').value.trim()
    });

    document.getElementById('standalone-trip-form').reset();
  });

  window.deleteTrip = function(key) {
    remove(ref(db, 'viagens/' + key));
  };
</script>
{% endblock %}