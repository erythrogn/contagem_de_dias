{% extends 'base.html' %}

{% block title %}Viagens · tamo junto{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/viagens.css') }}">
{% endblock %}

{% block content %}
<div class="wrap">

  <header class="page-header">
    <p class="eyebrow">lugares para explorar juntos</p>
    <h1 class="page-title">Nossa lista de<br><em>Viagens</em></h1>
    <p class="page-sub">os destinos só valheram a pena pq é com voce</p>
  </header>

  <div class="stats-bar" id="statsBar">
    <div class="stat">
      <div class="stat-num total" id="s-total">0</div>
      <div class="stat-label">total</div>
    </div>
    <div class="stat">
      <div class="stat-num sonho" id="s-sonho">0</div>
      <div class="stat-label">sonhos</div>
    </div>
    <div class="stat">
      <div class="stat-num plan" id="s-plan">0</div>
      <div class="stat-label">planejadas</div>
    </div>
    <div class="stat">
      <div class="stat-num feita" id="s-feita">0</div>
      <div class="stat-label">feitas</div>
    </div>
  </div>

  <section class="form-section">
    <div class="form-heading">nova viagem</div>
    <div class="form-grid">
      <div class="form-group">
        <label>destino</label>
        <input type="text" id="fDest" placeholder="ex: Lisboa, Portugal">
      </div>
      <div class="form-group">
        <label>período estimado</label>
        <input type="text" id="fData" placeholder="ex: julho 2026">
      </div>
      <div class="form-group">
        <label>status</label>
        <select id="fStatus">
          <option value="sonho">sonho</option>
          <option value="planejada">planejada</option>
          <option value="feita">já fomos!</option>
        </select>
      </div>
      <div class="form-group">
        <label>quem quer mais ir?</label>
        <input type="text" id="fQuem" placeholder="ex: os dois, mozi, eu...">
      </div>
      <div class="form-group span2">
        <label>o que queremos fazer lá</label>
        <textarea id="fNotes" placeholder="restaurantes, pontos turísticos, vontades..."></textarea>
      </div>
    </div>
    <button class="btn-submit" onclick="addTrip()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right: 8px;">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      Adicionar Viagem
    </button>
  </section>

  <div class="filter-row">
    <button class="ftab active" onclick="setFilter('all',this)">todas</button>
    <button class="ftab" onclick="setFilter('sonho',this)">sonhos</button>
    <button class="ftab" onclick="setFilter('planejada',this)">planejadas</button>
    <button class="ftab" onclick="setFilter('feita',this)">feitas</button>
  </div>

  <div class="trip-list" id="tripList"></div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

  const firebaseConfig = {
    databaseURL: "https://contagem-de-dias-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const viagensRef = ref(db, 'viagens');

  const ICONS = {
    sonho: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>`,
    planejada: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle></svg>`,
    feita: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`
  };

  const LABELS = { sonho: 'sonho', planejada: 'planejada', feita: 'feita' };
  const CLASS  = { sonho: 'badge-sonho', planejada: 'badge-planejada', feita: 'badge-feita' };

  let trips  = [];
  let currentFilter = 'all';

  onValue(viagensRef, (snapshot) => {
    trips = [];
    snapshot.forEach((childSnapshot) => {
      trips.push({ key: childSnapshot.key, ...childSnapshot.val() });
    });
    trips.reverse();
    render();
  });

  function updateStats() {
    document.getElementById('s-total').textContent = trips.length;
    document.getElementById('s-sonho').textContent = trips.filter(t => t.status === 'sonho').length;
    document.getElementById('s-plan').textContent  = trips.filter(t => t.status === 'planejada').length;
    document.getElementById('s-feita').textContent = trips.filter(t => t.status === 'feita').length;
  }

  function render() {
    const list = document.getElementById('tripList');
    list.innerHTML = '';
    const filtered = trips.filter(t => currentFilter === 'all' || t.status === currentFilter);

    if (!filtered.length) {
      const emptySvg = `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5; margin-bottom: 12px;"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21.5 4s-2 .5-3.5 2L14.5 9.5 6.3 7.7c-.5-.1-.9.1-1.1.5l-1.3 2.6c-.2.4-.1.8.3 1l4.4 2.2L6.4 16.2l-2.4-.6c-.4-.1-.8.1-1 .5L1.5 19l4.5 1.5 1.5 4.5 2.9-1.5c.4-.2.6-.6.5-1l-.6-2.4 2.2-2.2 2.2 4.4c.2.4.6.5 1 .3l2.6-1.3c.4-.2.6-.6.5-1.1z"></path></svg>`;
      list.innerHTML = `
        <div class="empty-state">
          ${emptySvg}<br>
          ${currentFilter === 'all' ? 'nenhuma viagem ainda... comecem a sonhar juntos!' : 'nada nessa categoria ainda.'}
        </div>`;
      return;
    }

    filtered.forEach(t => {
      const card = document.createElement('div');
      card.className = 'trip-card';
      card.dataset.status = t.status;
      
      const crossSvg = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;

      card.innerHTML = `
        <div class="trip-icon">${ICONS[t.status]}</div>
        <div class="trip-body">
          <div class="trip-dest">${t.dest}</div>
          <div class="trip-meta">${t.data ? t.data + ' · ' : ''}${t.quem ? 'sugestão: ' + t.quem : ''}</div>
          ${t.notes ? `<div class="trip-notes">${t.notes}</div>` : ''}
          <span class="status-badge ${CLASS[t.status]}">${ICONS[t.status]} ${LABELS[t.status]}</span>
        </div>
        <div class="trip-actions">
          <button class="btn-icon" title="remover" onclick="removeTrip('${t.key}')">${crossSvg}</button>
        </div>
      `;
      list.appendChild(card);
    });

    updateStats();
  }

  window.addTrip = async function() {
    const dest = document.getElementById('fDest').value.trim();
    if (!dest) { document.getElementById('fDest').focus(); return; }
    
    await push(viagensRef, {
      dest,
      data:   document.getElementById('fData').value.trim(),
      status: document.getElementById('fStatus').value,
      quem:   document.getElementById('fQuem').value.trim(),
      notes:  document.getElementById('fNotes').value.trim(),
    });

    ['fDest','fData','fQuem','fNotes'].forEach(id => document.getElementById(id).value = '');
  }

  window.removeTrip = function(key) {
    remove(ref(db, 'viagens/' + key));
  }

  window.setFilter = function(f, btn) {
    currentFilter = f;
    document.querySelectorAll('.ftab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    render();
  }
</script>
{% endblock %}