{% extends 'base.html' %}

{% block title %}Bloco de Notas · tamo junto{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bloco.css') }}">
{% endblock %}

{% block content %}
<div class="wrap">

  <header class="page-header">
    <span class="eyebrow">nossos registros e ideias</span>
    <h1 class="page-title">Bloco de<br><em>Notas</em></h1>
    <p class="page-sub">perguntas, listas e pensamentos soltos</p>
  </header>

  <section class="form-section" aria-label="Adicionar nota">
    <p class="form-heading">✦ Nova Anotação</p>

    <form id="note-form" class="form-grid" novalidate>
      <div class="form-group span2">
        <label for="nTitle">Título ou Pergunta</label>
        <input type="text" id="nTitle" placeholder="ex: O que você mais gosta em nós?" autocomplete="off" required>
      </div>

      <div class="form-group">
        <label for="nType">Tipo de Nota</label>
        <select id="nType" required>
          <option value="texto">Texto Livre</option>
          <option value="lista">Lista (um item por linha)</option>
          <option value="pergunta">Pergunta & Resposta</option>
        </select>
      </div>

      <div class="form-group">
        <label for="nAuthor">Quem escreveu?</label>
        <input type="text" id="nAuthor" placeholder="hesron, mozi...">
      </div>

      <div class="form-group span2" id="field-content">
        <label for="nContent">Conteúdo</label>
        <textarea id="nContent" rows="4" placeholder="Escreva aqui os detalhes ou os itens da lista..."></textarea>
      </div>

      <div class="form-group span2" id="field-answer" style="display:none;">
        <p class="field-hint">✦ A resposta será preenchida pela outra pessoa diretamente no card.</p>
      </div>

      <div class="form-group span2">
        <button type="submit" class="btn-submit">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
          <span>Salvar Nota</span>
        </button>
      </div>
    </form>
  </section>

  <div class="filter-row" role="tablist" aria-label="Filtrar notas">
    <button class="ftab active" data-filter="todos" role="tab">Tudo</button>
    <button class="ftab" data-filter="texto" role="tab">Textos</button>
    <button class="ftab" data-filter="lista" role="tab">Listas</button>
    <button class="ftab" data-filter="pergunta" role="tab">Perguntas</button>
  </div>

  <section class="notes-masonry" id="notesList" aria-live="polite">
    <div class="empty-state" style="grid-column: 1 / -1;">
      <p>✦</p>
      <p>O grimório está vazio. Escreva algo...</p>
    </div>
  </section>

</div>

<dialog id="edit-dialog-note" aria-labelledby="edit-note-title">
  <div class="dialog-header">
    <h3 id="edit-note-title" style="margin: 0; font-family: var(--font-title); color: var(--gold-pale);">Editar Nota</h3>
    <button type="button" class="btn-close-dialog" onclick="document.getElementById('edit-dialog-note').close()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>
  <form id="edit-note-form" class="form-grid" novalidate>
    <input type="hidden" id="edit-nKey">
    <div class="form-group span2">
      <label for="edit-nTitle">Título ou Pergunta</label>
      <input type="text" id="edit-nTitle" required>
    </div>
    <div class="form-group">
      <label for="edit-nType">Tipo</label>
      <select id="edit-nType" required>
        <option value="texto">Texto Livre</option>
        <option value="lista">Lista</option>
        <option value="pergunta">Pergunta & Resposta</option>
      </select>
    </div>
    <div class="form-group">
      <label for="edit-nAuthor">Autor</label>
      <input type="text" id="edit-nAuthor">
    </div>
    <div class="form-group span2" id="edit-field-content">
      <label for="edit-nContent">Conteúdo</label>
      <textarea id="edit-nContent" rows="5"></textarea>
    </div>
    <div class="form-group span2" id="edit-field-answer" style="display:none;">
      <label for="edit-nAnswer">Resposta</label>
      <textarea id="edit-nAnswer" rows="5"></textarea>
    </div>
    <div class="form-group span2">
      <button type="submit" class="btn-submit">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        <span>Salvar Alterações</span>
      </button>
    </div>
  </form>
</dialog>

<script type="module">
  import { ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
  import { db } from "/static/js/app.js";

  const notasRef = ref(db, 'bloco');
  let notes = [];
  let currentFilter = 'todos';
  const editDialog = document.getElementById('edit-dialog-note');

  // ── Usuário atual ──────────────────────────────────────────────────────────
  // Lê o nome do usuário de onde o app.js o armazena (window.currentUser ou
  // localStorage). Ajuste a chave abaixo para a que o seu app usa.
  function getCurrentUser() {
    return (window.currentUser || localStorage.getItem('userName') || '').trim().toLowerCase();
  }

  function isSameUser(a, b) {
    return a && b && a.trim().toLowerCase() === b.trim().toLowerCase();
  }

  // ── Auto-preenche o campo "Quem escreveu?" com o usuário logado ───────────
  const nAuthorEl = document.getElementById('nAuthor');
  const currentUser = getCurrentUser();
  if (currentUser && !nAuthorEl.value) nAuthorEl.value = currentUser;

  // ── Ícones ─────────────────────────────────────────────────────────────────
  const ICONS = {
    texto: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
    lista:  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>',
    pergunta: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>'
  };

  // ── Toggle campos pergunta/conteúdo no formulário ──────────────────────────
  function togglePerguntaFields(typeEl, contentFieldId, answerFieldId) {
    const isPergunta = typeEl.value === 'pergunta';
    document.getElementById(contentFieldId).style.display = isPergunta ? 'none' : '';
    document.getElementById(answerFieldId).style.display = isPergunta ? '' : 'none';
  }

  const nTypeEl = document.getElementById('nType');
  nTypeEl.addEventListener('change', () => togglePerguntaFields(nTypeEl, 'field-content', 'field-answer'));

  const editNTypeEl = document.getElementById('edit-nType');
  editNTypeEl.addEventListener('change', () => togglePerguntaFields(editNTypeEl, 'edit-field-content', 'edit-field-answer'));

  // ── Firebase listener ──────────────────────────────────────────────────────
  onValue(notasRef, (snapshot) => {
    notes = [];
    snapshot.forEach((childSnapshot) => {
      notes.push({ key: childSnapshot.key, ...childSnapshot.val() });
    });
    notes.reverse();
    renderNotes();
  });

  // ── Render ─────────────────────────────────────────────────────────────────
  function renderNotes() {
    const list = document.getElementById('notesList');
    list.innerHTML = '';
    const me = getCurrentUser();
    const filtered = notes.filter(n => currentFilter === 'todos' || n.type === currentFilter);

    if (!filtered.length) {
      list.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
          <p>✦</p>
          <p>Nenhuma anotação encontrada.</p>
        </div>`;
      return;
    }

    filtered.forEach(n => {
      const card = document.createElement('article');
      card.className = `note-card type-${n.type}`;

      let contentHtml = '';

      if (n.type === 'lista') {
        const items = n.content.split('\n').filter(i => i.trim() !== '');
        contentHtml = `<ul class="note-list">${items.map(i => `<li>${i}</li>`).join('')}</ul>`;

      } else if (n.type === 'pergunta') {
        const isAuthor   = isSameUser(me, n.author);
        const hasAnswer  = (n.answer || '').trim() !== '';

        if (hasAnswer) {
          // Todos veem a resposta após respondida
          contentHtml = `
            <div class="note-qa">
              <div class="note-qa-label">✦ resposta${n.answeredBy ? ` · por ${n.answeredBy}` : ''}</div>
              <div class="note-answer">${n.answer.replace(/\n/g, '<br>')}</div>
            </div>`;
        } else if (!isAuthor) {
          // Quem não fez a pergunta vê o campo para responder
          contentHtml = `
            <div class="note-qa note-qa-pending">
              <div class="note-qa-label">✦ aguardando resposta</div>
              <form class="inline-answer-form" data-key="${n.key}">
                <textarea class="inline-answer-input" rows="3" placeholder="Escreva sua resposta..."></textarea>
                <button type="submit" class="btn-inline-answer">
                  <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                  responder
                </button>
              </form>
            </div>`;
        } else {
          // Autor vê apenas que está aguardando
          contentHtml = `
            <div class="note-qa note-qa-pending">
              <div class="note-qa-label">✦ aguardando resposta</div>
              <p class="note-qa-waiting">a outra pessoa ainda não respondeu…</p>
            </div>`;
        }

      } else {
        contentHtml = `<p class="note-text">${n.content.replace(/\n/g, '<br>')}</p>`;
      }

      // Só mostra botão editar para o autor da nota
      const canEdit = isSameUser(me, n.author);
      card.innerHTML = `
        <div class="note-badge" title="${n.type}">${ICONS[n.type]}</div>
        <h3 class="note-title">${n.title}</h3>
        ${n.author ? `<div class="note-author">Por: ${n.author}</div>` : ''}
        <div class="note-body">${contentHtml}</div>
        <div class="note-actions">
          ${canEdit ? `
          <button class="btn-action edit" onclick="window.openEditNote('${n.key}')" aria-label="Editar">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          </button>` : ''}
          <button class="btn-action del" onclick="window.deleteNote('${n.key}')" aria-label="Excluir">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
      `;
      list.appendChild(card);
    });

    // Delegação de evento para os formulários inline de resposta
    list.querySelectorAll('.inline-answer-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const key    = form.dataset.key;
        const answer = form.querySelector('.inline-answer-input').value.trim();
        if (!answer) return;
        const btn = form.querySelector('.btn-inline-answer');
        btn.disabled = true;
        btn.textContent = '…';
        await update(ref(db, 'bloco/' + key), {
          answer,
          answeredBy: me || 'alguém',
          answeredAt: Date.now()
        });
      });
    });
  }

  // ── Criar nota ─────────────────────────────────────────────────────────────
  document.getElementById('note-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const type        = document.getElementById('nType').value;
    const isPergunta  = type === 'pergunta';
    const title       = document.getElementById('nTitle').value.trim();
    const content     = isPergunta ? '' : document.getElementById('nContent').value.trim();
    // Para perguntas, o campo de resposta no formulário de criação não faz sentido
    // (só a outra pessoa pode responder). Removemos o valor do campo.
    if (!title || (!isPergunta && !content)) return;

    await push(notasRef, {
      title,
      type,
      author:    document.getElementById('nAuthor').value.trim(),
      content,
      answer:    '',
      timestamp: Date.now()
    });

    document.getElementById('note-form').reset();
    if (currentUser) nAuthorEl.value = currentUser;
    togglePerguntaFields(nTypeEl, 'field-content', 'field-answer');
  });

  // ── Deletar nota ───────────────────────────────────────────────────────────
  window.deleteNote = function(key) {
    remove(ref(db, 'bloco/' + key));
  };

  // ── Editar nota ────────────────────────────────────────────────────────────
  window.openEditNote = function(key) {
    const n = notes.find(note => note.key === key);
    if (!n) return;

    document.getElementById('edit-nKey').value      = n.key;
    document.getElementById('edit-nTitle').value    = n.title   || '';
    document.getElementById('edit-nType').value     = n.type    || 'texto';
    document.getElementById('edit-nAuthor').value   = n.author  || '';
    document.getElementById('edit-nContent').value  = n.content || '';
    document.getElementById('edit-nAnswer').value   = n.answer  || '';

    togglePerguntaFields(editNTypeEl, 'edit-field-content', 'edit-field-answer');
    editDialog.showModal();
  };

  document.getElementById('edit-note-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const key           = document.getElementById('edit-nKey').value;
    const editType      = document.getElementById('edit-nType').value;
    const isEditPergunta = editType === 'pergunta';

    await update(ref(db, 'bloco/' + key), {
      title:   document.getElementById('edit-nTitle').value.trim(),
      type:    editType,
      author:  document.getElementById('edit-nAuthor').value.trim(),
      content: isEditPergunta ? '' : document.getElementById('edit-nContent').value.trim(),
      answer:  isEditPergunta ? document.getElementById('edit-nAnswer').value.trim() : ''
    });

    editDialog.close();
  });

  // ── Filtros ────────────────────────────────────────────────────────────────
  document.querySelectorAll('.ftab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      document.querySelectorAll('.ftab').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      currentFilter = e.target.dataset.filter;
      renderNotes();
    });
  });
</script>
{% endblock %}