{% extends 'base.html' %}

{% block title %}Filmes · tamo junto{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/filmes.css') }}">
{% endblock %}

{% block content %}
  <div class="marquee-wrapper" aria-hidden="true">
    <div class="marquee-track">
      <span class="marquee-text">Nossa lista de filmes</span>
      <span class="marquee-text">bastante pipoca</span>
      <span class="marquee-text">quero assistir minha vida com voce</span>
      <span class="marquee-text">te amo</span>
      <span class="marquee-text">Nossa lista de filmes</span>
      <span class="marquee-text">bastante pipoca</span>
      <span class="marquee-text">quero assistir minha vida com voce</span>
      <span class="marquee-text">te amo</span>
    </div>
  </div>

  <main class="filmes-container">
    <header class="filmes-header">
      <span class="filmes-eyebrow">o que vamos assistir juntos</span>
      <h1 class="filmes-title">nossa lista de <span class="filmes-accent">filmes</span></h1>
      <p class="filmes-subtitle">coloca um filme p nos mozi</p>
    </header>

    <section class="progress-wrapper" aria-label="Progresso de filmes assistidos">
      <div class="progress-details">
        <span class="progress-label-text">Assistidos</span>
        <strong class="progress-number" id="progressLabel">0 / 0</strong>
      </div>
      <div class="progress-track" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </section>

    <section class="form-wrapper" aria-label="Adicionar filme">
      <h2 class="form-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
        Adicionar Filme
      </h2>
      <form id="standalone-movie-form" class="form-layout" novalidate>
        <div class="field-group span-full" style="display:flex; gap:16px; align-items:flex-start;">
          <div style="flex:1;">
            <label for="fTitle" class="field-label">Título do Filme</label>
            <input type="text" id="fTitle" class="field-input" placeholder="ex: Interstellar..." autocomplete="off" required>
          </div>
          <div id="poster-preview-box" style="flex-shrink:0; width:80px; height:120px; border-radius:8px; overflow:hidden; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; transition: all 0.3s ease;">
            <svg id="poster-placeholder-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line></svg>
            <img id="poster-preview-img" src="" alt="Capa" style="display:none; width:100%; height:100%; object-fit:cover;">
          </div>
        </div>
        
        <div class="field-group">
          <label for="targetDate" class="field-label">Quando vamos assistir?</label>
          <input type="date" id="targetDate" class="field-input" required>
        </div>
        <div class="field-group">
          <label for="fGenre" class="field-label">Gênero</label>
          <input type="text" id="fGenre" class="field-input" placeholder="ex: terror, animação...">
        </div>
        <div class="field-group">
          <label for="fYear" class="field-label">Ano Lançamento</label>
          <input type="text" id="fYear" class="field-input" placeholder="ex: 2011" maxlength="4">
        </div>
        <div class="field-group">
          <label for="fWho" class="field-label">Quem indicou?</label>
          <input type="text" id="fWho" class="field-input" placeholder="hesrin ou mozi">
        </div>
        <div class="field-group span-full">
          <label for="fWhere" class="field-label">Onde assistir?</label>
          <input type="text" id="fWhere" class="field-input" placeholder="ex: Locadoras Digitais">
        </div>
        <div class="field-group span-full">
          <button class="btn-submit" id="btn-standalone-add" type="submit">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <span>Adicionar Filme</span>
          </button>
        </div>
      </form>
    </section>

    <nav class="filter-wrapper" role="tablist" aria-label="Filtrar filmes">
      <button class="ftab active" data-filter="todos" role="tab" aria-selected="true">Todos</button>
      <button class="ftab" data-filter="assistir" role="tab" aria-selected="false">Para Assistir</button>
      <button class="ftab" data-filter="assistido" role="tab" aria-selected="false">Assistidos</button>
    </nav>

    <div class="genre-wrapper" id="genreRow" aria-label="Filtrar por gênero">
      <button class="gtag active" data-genre="todos">Todos os Gêneros</button>
    </div>

    <section class="slider-section">
      <button id="slider-prev" class="slider-btn prev" aria-label="Anterior" onclick="window.prevSlide()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      
      <div class="slider-track" id="movieList" aria-live="polite">
        <div class="empty-state">
          <svg class="empty-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
          <p class="empty-text">falta filmes ein</p>
        </div>
      </div>

      <button id="slider-next" class="slider-btn next" aria-label="Próximo" onclick="window.nextSlide()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>
    </section>

  </main>

  <dialog id="edit-dialog-movie" aria-labelledby="edit-movie-title">
    <div class="dialog-header">
      <h3 id="edit-movie-title" style="margin: 0; font-family: var(--font-display, sans-serif);">Editar Filme</h3>
      <button type="button" class="btn-close-dialog" onclick="document.getElementById('edit-dialog-movie').close()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <form id="edit-movie-form" class="form-layout" novalidate>
      <input type="hidden" id="edit-mKey">
      <div class="field-group span-full">
        <label for="edit-mTitle" class="field-label">Título</label>
        <input type="text" id="edit-mTitle" class="field-input" required>
      </div>
      <div class="field-group">
        <label for="edit-mTargetDate" class="field-label">Data</label>
        <input type="date" id="edit-mTargetDate" class="field-input" required>
      </div>
      <div class="field-group">
        <label for="edit-mGenre" class="field-label">Gênero</label>
        <input type="text" id="edit-mGenre" class="field-input">
      </div>
      <div class="field-group">
        <label for="edit-mYear" class="field-label">Ano</label>
        <input type="text" id="edit-mYear" class="field-input" maxlength="4">
      </div>
      <div class="field-group">
        <label for="edit-mWho" class="field-label">Quem indicou?</label>
        <input type="text" id="edit-mWho" class="field-input">
      </div>
      <div class="field-group span-full">
        <label for="edit-mWhere" class="field-label">Onde assistir?</label>
        <input type="text" id="edit-mWhere" class="field-input">
      </div>
      <div class="field-group span-full">
        <button class="btn-submit" id="btn-edit-movie-submit" type="submit">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
          <span>Salvar Alterações</span>
        </button>
      </div>
    </form>
  </dialog>

 <script type="module">
  import { ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
  import { db } from "/static/js/app.js";

  const filmesRef = ref(db, 'filmes');

  let movies = [];
  let filteredMovies = [];
  let currentIndex = 0;
  let currentFilter = 'todos';
  let currentGenre = 'todos';
  const TMDB_API_KEY = "d39bbf74a96f6cca570dcb69c8f3059f";
  const editDialog = document.getElementById('edit-dialog-movie');

  const FALLBACK_POSTER = "https://placehold.co/300x450/1a1c23/4da6ff?text=Sem+Capa";

  onValue(filmesRef, (snapshot) => {
    movies = [];
    snapshot.forEach((childSnapshot) => {
      movies.push({ key: childSnapshot.key, ...childSnapshot.val() });
    });
    movies.reverse();
    updateProgress();
    renderGenres();
    renderMovies();
  });

  function updateProgress() {
    const total = movies.length;
    const watched = movies.filter(m => m.watched).length;
    const pct = total ? Math.round((watched / total) * 100) : 0;
    document.getElementById('progressLabel').textContent = `${watched} / ${total}`;
    document.getElementById('progressFill').style.width = `${pct}%`;
  }

  function renderGenres() {
    const genreSet = new Set();
    movies.forEach(m => {
      if (m.genre) {
        m.genre.split(',').forEach(g => {
          const cleanG = g.trim().toLowerCase();
          if (cleanG) genreSet.add(cleanG);
        });
      }
    });
    
    const genresArray = Array.from(genreSet).sort();
    const row = document.getElementById('genreRow');
    let html = `<button class="gtag ${currentGenre === 'todos' ? 'active' : ''}" data-genre="todos">Todos os Gêneros</button>`;
    
    genresArray.forEach(g => {
      html += `<button class="gtag ${currentGenre === g ? 'active' : ''}" data-genre="${g}">${g}</button>`;
    });
    
    row.innerHTML = html;

    document.querySelectorAll('.gtag').forEach(btn => {
      btn.addEventListener('click', (e) => {
        currentGenre = e.target.dataset.genre;
        renderGenres();
        renderMovies();
      });
    });
  }

  function renderMovies() {
    const track = document.getElementById('movieList');
    track.innerHTML = '';

    filteredMovies = movies.filter(m => {
      if (currentFilter === 'assistido' && !m.watched) return false;
      if (currentFilter === 'assistir' && m.watched) return false;
      if (currentGenre !== 'todos') {
        if (!m.genre) return false;
        const mGenres = m.genre.toLowerCase().split(',').map(g => g.trim());
        if (!mGenres.includes(currentGenre)) return false;
      }
      return true;
    });

    if (!filteredMovies.length) {
      track.innerHTML = `
        <div class="empty-state" style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;">
          <svg class="empty-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem;"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
          <p class="empty-text">Nenhum filme encontrado.</p>
        </div>`;
      document.getElementById('slider-prev').style.display = 'none';
      document.getElementById('slider-next').style.display = 'none';
      return;
    }

    document.getElementById('slider-prev').style.display = 'flex';
    document.getElementById('slider-next').style.display = 'flex';

    filteredMovies.forEach((m, idx) => {
      const card = document.createElement('div');
      card.className = `slider-card ${m.watched ? 'watched' : ''}`;
      
      // ── MELHORIA PRINCIPAL ────────────────────────────────────────
      let posterUrl = m.poster;
      if (!posterUrl || posterUrl === "" || posterUrl === "N/A") {
        posterUrl = FALLBACK_POSTER;
      }

      const dateStr = m.targetDate ? m.targetDate.split('-').reverse().join('/') : '';

      card.innerHTML = `
        <img src="${posterUrl}" 
             class="movie-poster-img" 
             alt="${m.title}"
             onerror="this.src='${FALLBACK_POSTER}'; this.onerror=null;">
        <div class="movie-info-overlay">
          <h3 class="movie-title">${m.title}</h3>
          <div class="movie-meta">
            ${dateStr} ${m.where ? `• ${m.where}` : ''} ${m.who ? `• indicação: ${m.who}` : ''}
          </div>
          <div class="actions-group">
            <button class="movie-action-btn check ${m.watched ? 'checked' : ''}" onclick="event.stopPropagation(); window.toggleMovie('${m.key}', ${m.watched})" aria-label="Marcar como visto">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </button>
            <button class="movie-action-btn edit" onclick="event.stopPropagation(); window.openEditMovie('${m.key}')" aria-label="Editar filme">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            </button>
            <button class="movie-action-btn delete" onclick="event.stopPropagation(); window.deleteMovie('${m.key}')" aria-label="Deletar filme">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
          </div>
        </div>
      `;

      card.addEventListener('click', () => {
        if (idx !== currentIndex) {
          currentIndex = idx;
          updateSlider();
        }
      });

      track.appendChild(card);
    });

    currentIndex = 0;
    updateSlider();
  }

  function updateSlider() {
    const cards = document.querySelectorAll('.slider-card');
    cards.forEach((card, idx) => {
      card.className = `slider-card ${filteredMovies[idx].watched ? 'watched' : ''}`;
      if (idx === currentIndex) {
        card.classList.add('active');
      } else if (idx === currentIndex - 1) {
        card.classList.add('prev');
      } else if (idx === currentIndex + 1) {
        card.classList.add('next');
      } else {
        card.classList.add('hidden');
      }
    });
  }

  window.prevSlide = function() {
    if (currentIndex > 0) {
      currentIndex--;
      updateSlider();
    }
  };

  window.nextSlide = function() {
    if (currentIndex < filteredMovies.length - 1) {
      currentIndex++;
      updateSlider();
    }
  };

  async function fetchPoster(title, year = "") {
  if (!title?.trim()) return "";

  try {
    let url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title.trim())}&language=pt-BR`;
    if (year && /^\d{4}$/.test(year)) {
      url += `&primary_release_year=${year}`;
    }

    let res = await fetch(url);
    if (!res.ok) {
      console.error(`TMDB erro HTTP: ${res.status} - ${res.statusText}`);
      throw new Error('Resposta inválida');
    }

    let data = await res.json();

    if (data?.results?.length > 0 && data.results[0].poster_path) {
      return `https://image.tmdb.org/t/p/w500${data.results[0].poster_path}`;
    }

    url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title.trim())}&language=en-US`;
    if (year && /^\d{4}$/.test(year)) url += `&primary_release_year=${year}`;

    res = await fetch(url);
    data = await res.json();

    if (data?.results?.length > 0 && data.results[0].poster_path) {
      return `https://image.tmdb.org/t/p/w500${data.results[0].poster_path}`;
    }

  } catch (err) {
    console.error("Erro ao buscar poster do TMDB:", title, year, err);
  }

  return "";
}

  // ── Preview ao digitar ────────────────────────────────────────────
  let debounceTimer;
  const titleInput = document.getElementById('fTitle');
  const yearInput = document.getElementById('fYear');
  const previewBox = document.getElementById('poster-preview-box');
  const previewImg = document.getElementById('poster-preview-img');
  const placeholderIcon = document.getElementById('poster-placeholder-icon');

  function triggerPreview() {
    clearTimeout(debounceTimer);
    const title = titleInput.value.trim();
    if (!title) {
      previewImg.style.display = 'none';
      placeholderIcon.style.display = 'block';
      return;
    }

    debounceTimer = setTimeout(async () => {
      previewBox.style.opacity = '0.5';
      const url = await fetchPoster(title, yearInput.value.trim());
      previewBox.style.opacity = '1';

      if (url) {
        previewImg.src = url;
        previewImg.style.display = 'block';
        placeholderIcon.style.display = 'none';
      } else {
        previewImg.style.display = 'none';
        placeholderIcon.style.display = 'block';
      }
    }, 700);
  }

  titleInput.addEventListener('input', triggerPreview);
  yearInput.addEventListener('input', triggerPreview);

  
  document.getElementById('standalone-movie-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('fTitle').value.trim();
    if (!title) return;

    const year = document.getElementById('fYear').value.trim();
    const targetDate = document.getElementById('targetDate').value;
    const btn = document.getElementById('btn-standalone-add');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span>Buscando Capa...</span>';

    const posterUrl = await fetchPoster(title, year);

    await push(filmesRef, {
      title,
      year,
      targetDate,
      genre: document.getElementById('fGenre').value.trim(),
      who: document.getElementById('fWho').value.trim(),
      where: document.getElementById('fWhere').value.trim(),
      poster: posterUrl || "",  
      watched: false
    });

    document.getElementById('standalone-movie-form').reset();
    previewImg.style.display = 'none';
    placeholderIcon.style.display = 'block';
    btn.innerHTML = originalText;
  });

  window.toggleMovie = function(key, isWatched) {
    update(ref(db, 'filmes/' + key), { watched: !isWatched });
  };

  window.deleteMovie = function(key) {
    if (confirm("Tem certeza que deseja excluir esse filme?")) {
      remove(ref(db, 'filmes/' + key));
    }
  };

  window.openEditMovie = function(key) {
    const m = movies.find(m => m.key === key);
    if (!m) return;

    document.getElementById('edit-mKey').value = m.key;
    document.getElementById('edit-mTitle').value = m.title || '';
    document.getElementById('edit-mTargetDate').value = m.targetDate || '';
    document.getElementById('edit-mGenre').value = m.genre || '';
    document.getElementById('edit-mYear').value = m.year || '';
    document.getElementById('edit-mWho').value = m.who || '';
    document.getElementById('edit-mWhere').value = m.where || '';

    editDialog.showModal();
  };

  document.getElementById('edit-movie-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const key = document.getElementById('edit-mKey').value;
    const originalMovie = movies.find(m => m.key === key);
    if (!originalMovie) return;

    const newTitle = document.getElementById('edit-mTitle').value.trim();
    const newYear = document.getElementById('edit-mYear').value.trim();
    const btn = document.getElementById('btn-edit-movie-submit');
    const originalText = btn.innerHTML;

    let finalPoster = originalMovie.poster || "";

    if (newTitle !== originalMovie.title || newYear !== (originalMovie.year || "")) {
      btn.innerHTML = '<span>Atualizando Capa...</span>';
      const fetchedPoster = await fetchPoster(newTitle, newYear);
      if (fetchedPoster) finalPoster = fetchedPoster;
    }

    await update(ref(db, 'filmes/' + key), {
      title: newTitle,
      year: newYear,
      targetDate: document.getElementById('edit-mTargetDate').value,
      genre: document.getElementById('edit-mGenre').value.trim(),
      who: document.getElementById('edit-mWho').value.trim(),
      where: document.getElementById('edit-mWhere').value.trim(),
      poster: finalPoster
    });

    btn.innerHTML = originalText;
    editDialog.close();
  });

  document.querySelectorAll('.ftab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      document.querySelectorAll('.ftab').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      currentFilter = e.target.dataset.filter;
      renderMovies();
    });
  });
</script>
{% endblock %}