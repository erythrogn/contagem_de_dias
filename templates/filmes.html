{% extends 'base.html' %}

{% block title %}Filmes · tamo junto{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/filmes.css') }}">
{% endblock %}

{% block content %}
  <div class="marquee-bar">
    <div class="marquee-inner">
      <span>sessão a dois</span>
      <span>pipoca e você</span>
      <span>nossa lista</span>
      <span>próximo da fila</span>
      <span>sessão a dois</span>
      <span>pipoca e você</span>
      <span>nossa lista</span>
      <span>próximo da fila</span>
      <span>sessão a dois</span>
      <span>pipoca e você</span>
      <span>nossa lista</span>
      <span>próximo da fila</span>
    </div>
  </div>

  <div class="wrap">

    <header class="page-header">
      <p class="eyebrow">lista de sessão · para assistir juntos</p>
      <h1 class="page-title">nossa<br>lista de<br><span class="accent">filmes</span></h1>
      <p class="page-sub">coloca um filme ai mozi</p>
    </header>

    <div class="watch-progress" id="progressWrap">
      <div class="progress-label">
        <span>progresso</span>
        <strong id="progressPct">0%</strong>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </div>

    <section class="form-section">
      <div class="form-heading">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> 
        adicionar filme
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>título do filme</label>
          <input type="text" id="fTitle" placeholder="ex: La La Land...">
        </div>
        <div class="form-group">
          <label>ano</label>
          <input type="text" id="fYear" placeholder="ex: 2024">
        </div>
        <div class="form-group">
          <label>gênero</label>
          <input type="text" id="fGenre" placeholder="ex: romance, terror, comédia...">
        </div>
        <div class="form-group">
          <label>quem indicou</label>
          <input type="text" id="fWho" placeholder="você, mozi ou os dois?">
        </div>
        <div class="form-group">
          <label>onde assistir</label>
          <input type="text" id="fWhere" placeholder="ex: Netflix, Prime, cinema...">
        </div>
        <div class="form-group">
          <label>motivo</label>
          <input type="text" id="fReason" placeholder="por que querem assistir?">
        </div>
      </div>
      <button class="btn-submit" onclick="addMovie()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        Adicionar
      </button>
    </section>

    <div class="filter-row">
      <button class="ftab active" onclick="setFilter('all',this)">todos</button>
      <button class="ftab" onclick="setFilter('pending',this)">pra ver</button>
      <button class="ftab" onclick="setFilter('watched',this)">assistidos</button>
    </div>

    <div class="genre-row" id="genreRow">
      <button class="gtag active" onclick="setGenre('',this)">todos os gêneros</button>
    </div>

    <div class="movie-list" id="movieList"></div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://contagem-de-dias-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const filmesRef = ref(db, 'filmes');

    let movies = [];
    let currentFilter = 'all';
    let genreFilter = '';

    onValue(filmesRef, (snapshot) => {
      movies = [];
      snapshot.forEach((childSnapshot) => {
        movies.push({ key: childSnapshot.key, ...childSnapshot.val() });
      });
      movies.reverse();
      render();
    });

    function allGenres() {
      const set = new Set();
      movies.forEach(m => { if (m.genre) m.genre.split(',').forEach(g => set.add(g.trim().toLowerCase())); });
      return [...set].sort();
    }

    function updateGenreRow() {
      const row = document.getElementById('genreRow');
      row.innerHTML = `<button class="gtag ${genreFilter===''?'active':''}" onclick="setGenre('',this)">todos os gêneros</button>`;
      allGenres().forEach(g => {
        const btn = document.createElement('button');
        btn.className = `gtag ${genreFilter===g?'active':''}`;
        btn.textContent = g;
        btn.onclick = function() { window.setGenre(g, this); };
        row.appendChild(btn);
      });
    }

    function updateProgress() {
      const total   = movies.length;
      const watched = movies.filter(m => m.watched).length;
      const pct     = total ? Math.round((watched / total) * 100) : 0;
      document.getElementById('progressPct').textContent = pct + '%';
      document.getElementById('progressFill').style.width = pct + '%';
    }

    function render() {
      const list = document.getElementById('movieList');
      list.innerHTML = '';

      let filtered = movies.filter(m => {
        if (currentFilter === 'watched') return m.watched;
        if (currentFilter === 'pending') return !m.watched;
        return true;
      });

      if (genreFilter) {
        filtered = filtered.filter(m =>
          m.genre && m.genre.toLowerCase().split(',').map(s=>s.trim()).includes(genreFilter)
        );
      }

      if (!filtered.length) {
        const emptyIcon = `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5; margin-bottom: 12px;"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>`;
        list.innerHTML = `
          <div class="empty-state">
            ${emptyIcon}<br>
            ${currentFilter==='watched' ? 'ainda não assistiram nenhum...' :
              currentFilter==='pending' ? 'lista vazia! adicionem um filme.' :
              'nenhum filme ainda. comecem a lista!'}
          </div>`;
        return;
      }

      filtered.forEach(m => {
        const card = document.createElement('div');
        card.className = `movie-card${m.watched ? ' watched' : ''}`;

        const tags = [];
        if (m.genre) m.genre.split(',').forEach(g => {
          tags.push(`<span class="m-tag genre">${g.trim()}</span>`);
        });
        
        const starIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
        if (m.who) tags.push(`<span class="m-tag quem">${starIcon} ${m.who}</span>`);
        if (m.where) tags.push(`<span class="m-tag">${m.where}</span>`);

        const checkSvg = m.watched ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>` : '';
        const crossSvg = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;

        card.innerHTML = `
          <div class="m-check ${m.watched?'checked':''}" onclick="toggle('${m.key}', ${m.watched})">
            ${checkSvg}
          </div>
          <div class="m-info">
            <div class="m-title">${m.title}</div>
            <div class="m-meta">${m.year || '—'}${m.reason ? ' · ' + m.reason : ''}</div>
            ${tags.length ? `<div class="m-tags">${tags.join('')}</div>` : ''}
          </div>
          <div class="m-actions">
            <button class="btn-del" title="remover" onclick="removeMovie('${m.key}')">${crossSvg}</button>
          </div>
        `;
        list.appendChild(card);
      });

      updateProgress();
      updateGenreRow();
    }

    window.addMovie = async function() {
      const title = document.getElementById('fTitle').value.trim();
      if (!title) { document.getElementById('fTitle').focus(); return; }
      
      await push(filmesRef, {
        title,
        year:    document.getElementById('fYear').value.trim(),
        genre:   document.getElementById('fGenre').value.trim(),
        who:     document.getElementById('fWho').value.trim(),
        where:   document.getElementById('fWhere').value.trim(),
        reason:  document.getElementById('fReason').value.trim(),
        watched: false,
      });

      ['fTitle','fYear','fGenre','fWho','fWhere','fReason'].forEach(id =>
        document.getElementById(id).value = ''
      );
    }

    window.toggle = function(key, isWatched) {
      update(ref(db, 'filmes/' + key), { watched: !isWatched });
    }

    window.removeMovie = function(key) {
      remove(ref(db, 'filmes/' + key));
    }

    window.setFilter = function(f, btn) {
      currentFilter = f;
      document.querySelectorAll('.ftab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render();
    }

    window.setGenre = function(g, btn) {
      genreFilter = g;
      document.querySelectorAll('.gtag').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render();
    }
  </script>
{% endblock %}