{% extends 'base.html' %}

{% block title %}Filmes · tamo junto{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/filmes.css') }}">
{% endblock %}

{% block content %}
  <div class="marquee-wrapper" aria-hidden="true">
    <div class="marquee-track">
      <span class="marquee-text">Nossa lista de filmes</span>
      <span class="marquee-text">bastante pipoca</span>
      <span class="marquee-text">quero assistir minha vida com voce</span>
      <span class="marquee-text">te amo</span>
      <span class="marquee-text">Nossa lista de filmes</span>
      <span class="marquee-text">bastante pipoca</span>
      <span class="marquee-text">quero assistir minha vida com voce</span>
      <span class="marquee-text">te amo</span>
    </div>
  </div>

  <main class="filmes-container">
    <header class="filmes-header">
      <span class="filmes-eyebrow">o que vamos assistir juntos</span>
      <h1 class="filmes-title">nossa lista de <span class="filmes-accent">filmes</span></h1>
      <p class="filmes-subtitle">coloca um filme p nos mozi</p>
    </header>

    <section class="progress-wrapper" aria-label="Progresso de filmes assistidos">
      <div class="progress-details">
        <span class="progress-label-text">Assistidos</span>
        <strong class="progress-number" id="progressLabel">0 / 0</strong>
      </div>
      <div class="progress-track" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </section>

    <section class="form-wrapper" aria-label="Adicionar filme">
      <h2 class="form-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
        Adicionar Filme
      </h2>
      <form id="standalone-movie-form" class="form-layout" novalidate>
        <div class="field-group span-full" style="display:flex; gap:16px; align-items:flex-start;">
          <div style="flex:1;">
            <label for="fTitle" class="field-label">Título do Filme</label>
            <input type="text" id="fTitle" class="field-input" placeholder="ex: Interstellar..." autocomplete="off" required>
          </div>
          <div id="poster-preview-box" style="flex-shrink:0; width:80px; height:120px; border-radius:8px; overflow:hidden; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; transition: all 0.3s ease;">
            <svg id="poster-placeholder-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line></svg>
            <img id="poster-preview-img" src="" alt="Capa" style="display:none; width:100%; height:100%; object-fit:cover;">
          </div>
        </div>
        <div class="field-group">
          <label for="fGenre" class="field-label">Gênero</label>
          <input type="text" id="fGenre" class="field-input" placeholder="ex: Sci-Fi, Drama...">
        </div>
        <div class="field-group">
          <label for="fYear" class="field-label">Ano</label>
          <input type="text" id="fYear" class="field-input" placeholder="ex: 2014" maxlength="4">
        </div>
        <div class="field-group">
          <label for="fWho" class="field-label">Quem indicou?</label>
          <input type="text" id="fWho" class="field-input" placeholder="hesron ou mozi">
        </div>
        <div class="field-group">
          <label for="fWhere" class="field-label">Onde assistir?</label>
          <input type="text" id="fWhere" class="field-input" placeholder="ex: Netflix, Prime...">
        </div>
        <div class="field-group span-full">
          <label for="fReason" class="field-label">Por que assistir?</label>
          <input type="text" id="fReason" class="field-input" placeholder="ex: indicado por amigos...">
        </div>
        <div class="field-group span-full">
          <button class="btn-submit" id="btn-standalone-add" type="submit">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <span>Adicionar Filme</span>
          </button>
        </div>
      </form>
    </section>

    <nav class="filter-wrapper" role="tablist" aria-label="Filtrar filmes">
      <button class="ftab active" data-filter="todos" role="tab" aria-selected="true">Todos</button>
      <button class="ftab" data-filter="assistir" role="tab" aria-selected="false">Para Assistir</button>
      <button class="ftab" data-filter="assistido" role="tab" aria-selected="false">Assistidos</button>
    </nav>

    <div class="genre-wrapper" id="genreRow" aria-label="Filtrar por gênero">
      <button class="gtag active" data-genre="todos">Todos os Gêneros</button>
    </div>

    <section class="movies-grid" id="movieList" aria-label="Lista de filmes" aria-live="polite">
      <div class="empty-state" style="grid-column: 1 / -1;">
        <svg class="empty-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
        <p class="empty-text">Aguardando filmes...</p>
      </div>
    </section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://contagem-de-dias-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const filmesRef = ref(db, 'filmes');

    let movies = [];
    let currentFilter = 'todos';
    let currentGenre = 'todos';

    onValue(filmesRef, (snapshot) => {
      movies = [];
      snapshot.forEach((childSnapshot) => {
        movies.push({ key: childSnapshot.key, ...childSnapshot.val() });
      });
      movies.reverse();
      updateProgress();
      renderGenres();
      renderMovies();
    });

    function updateProgress() {
      const total = movies.length;
      const watched = movies.filter(m => m.watched).length;
      const pct = total ? Math.round((watched / total) * 100) : 0;
      document.getElementById('progressLabel').textContent = `${watched} / ${total}`;
      document.getElementById('progressFill').style.width = `${pct}%`;
    }

    function renderGenres() {
      const genreSet = new Set();
      movies.forEach(m => {
        if (m.genre) {
          m.genre.split(',').forEach(g => {
            const cleanG = g.trim().toLowerCase();
            if (cleanG) genreSet.add(cleanG);
          });
        }
      });
      
      const genresArray = Array.from(genreSet).sort();
      const row = document.getElementById('genreRow');
      let html = `<button class="gtag ${currentGenre === 'todos' ? 'active' : ''}" data-genre="todos">Todos os Gêneros</button>`;
      
      genresArray.forEach(g => {
        html += `<button class="gtag ${currentGenre === g ? 'active' : ''}" data-genre="${g}">${g}</button>`;
      });
      
      row.innerHTML = html;

      document.querySelectorAll('.gtag').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentGenre = e.target.dataset.genre;
          renderGenres();
          renderMovies();
        });
      });
    }

    function renderMovies() {
      const list = document.getElementById('movieList');
      list.innerHTML = '';

      const filtered = movies.filter(m => {
        if (currentFilter === 'assistido' && !m.watched) return false;
        if (currentFilter === 'assistir' && m.watched) return false;
        
        if (currentGenre !== 'todos') {
          if (!m.genre) return false;
          const mGenres = m.genre.toLowerCase().split(',').map(g => g.trim());
          if (!mGenres.includes(currentGenre)) return false;
        }
        return true;
      });

      if (!filtered.length) {
        list.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <svg class="empty-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
            <p class="empty-text">Nenhum filme encontrado nesta categoria.</p>
          </div>`;
        return;
      }

      filtered.forEach(m => {
        const card = document.createElement('div');
        card.className = `movie-card ${m.watched ? 'watched' : ''}`;

        const tagsHTML = m.genre ? m.genre.split(',').map(g => `<span class="movie-tag">${g.trim()}</span>`).join('') : '';
        const fallbackImg = "https://placehold.co/300x450/1a1c23/4da6ff?text=Sem+Capa";
        let finalPoster = m.poster && m.poster !== "N/A" ? m.poster : fallbackImg;

        card.innerHTML = `
          <div class="movie-poster-box">
            <img src="${finalPoster}" onerror="this.onerror=null;this.src='${fallbackImg}';" class="movie-poster-img" alt="${m.title}">
            <div class="movie-overlay">
              <button class="movie-action-btn check" onclick="window.toggleMovie('${m.key}', ${m.watched})">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
              </button>
              <button class="movie-action-btn delete" onclick="window.deleteMovie('${m.key}')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
          </div>
          <div class="movie-info-box">
            <h3 class="movie-title">${m.title}</h3>
            <div class="movie-meta-row">
              <span>${m.year || '----'}</span>
              ${m.where ? `<span> • ${m.where}</span>` : ''}
            </div>
            ${m.who ? `<div class="movie-meta-row" style="color:var(--gold)"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg> ${m.who}</div>` : ''}
            <div class="movie-tag-list">${tagsHTML}</div>
          </div>
        `;
        list.appendChild(card);
      });
    }

    const TMDB_API_KEY = "15d2ea6d0dc1d476efbcaa3bf5146885";

    async function fetchPoster(title, year) {
      try {
        const queryYear = year ? `&primary_release_year=${year}` : '';
        let res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}&language=pt-BR${queryYear}`);
        let data = await res.json();
        
        if (!data.results || data.results.length === 0) {
          res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}&language=en-US${queryYear}`);
          data = await res.json();
        }

        if (data.results && data.results.length > 0) {
          const posterPath = data.results[0].poster_path;
          if (posterPath) {
            return `https://image.tmdb.org/t/p/w500${posterPath}`;
          }
        }
      } catch(e) {
        console.error("Erro na busca de imagem:", e);
      }
      return "";
    }

    let debounceTimer;
    const titleInput = document.getElementById('fTitle');
    const yearInput = document.getElementById('fYear');
    const previewBox = document.getElementById('poster-preview-box');
    const previewImg = document.getElementById('poster-preview-img');
    const placeholderIcon = document.getElementById('poster-placeholder-icon');

    function triggerPreview() {
      clearTimeout(debounceTimer);
      const title = titleInput.value.trim();
      if (!title) {
        previewImg.style.display = 'none';
        placeholderIcon.style.display = 'block';
        return;
      }
      debounceTimer = setTimeout(async () => {
        previewBox.style.opacity = '0.5';
        const url = await fetchPoster(title, yearInput.value.trim());
        previewBox.style.opacity = '1';
        if (url) {
          previewImg.src = url;
          previewImg.style.display = 'block';
          placeholderIcon.style.display = 'none';
        } else {
          previewImg.style.display = 'none';
          placeholderIcon.style.display = 'block';
        }
      }, 700);
    }

    titleInput.addEventListener('input', triggerPreview);
    yearInput.addEventListener('input', triggerPreview);

    document.getElementById('standalone-movie-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('fTitle').value.trim();
      if (!title) return;

      const year = document.getElementById('fYear').value.trim();
      const btn = document.getElementById('btn-standalone-add');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span>Buscando Capa...</span>';
      
      const posterUrl = await fetchPoster(title, year);

      await push(filmesRef, {
        title,
        year,
        genre: document.getElementById('fGenre').value.trim(),
        who: document.getElementById('fWho').value.trim(),
        where: document.getElementById('fWhere').value.trim(),
        reason: document.getElementById('fReason').value.trim(),
        poster: posterUrl,
        watched: false
      });

      document.getElementById('standalone-movie-form').reset();
      previewImg.style.display = 'none';
      placeholderIcon.style.display = 'block';
      btn.innerHTML = originalText;
    });

    window.toggleMovie = function(key, isWatched) {
      update(ref(db, 'filmes/' + key), { watched: !isWatched });
    };

    window.deleteMovie = function(key) {
      remove(ref(db, 'filmes/' + key));
    };

    document.querySelectorAll('.ftab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        document.querySelectorAll('.ftab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        renderMovies();
      });
    });
  </script>
{% endblock %}